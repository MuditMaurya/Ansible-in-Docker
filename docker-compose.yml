version: "3.3"
services:
    controller:
        build:
            context: .
            dockerfile: ./controller
        volumes:
            - type: volume
              source: keys
              target: /keys/
            - ./controller-data/:/home/
        working_dir: /home/
        command: ['/bin/sh','-c','echo -e "StrictHostKeyChecking no \nUserKnownHostsFile /dev/null \nLogLevel QUIET" >> /etc/ssh/ssh_config &&cp ~/.ssh/id_rsa.pub /keys/authorized_keys && while true; do sleep 10s ; done']
        container_name: ansible-controller
    node1:
        image: node_image:latest
        build:
            context: .
            dockerfile: ./nodes
        volumes:
            - type: volume
              source: keys
              target: /root/.ssh/
        working_dir: /home/
        depends_on:
            - controller 
    node2:
        image: node_image:latest
        volumes:
            - type: volume
              source: keys
              target: /root/.ssh/
        working_dir: /home/
        depends_on:
            - controller
    node3:
        image: node_image:latest
        volumes:
            - type: volume
              source: keys
              target: /root/.ssh/
        working_dir: /home/
        depends_on:
            - controller
volumes:
    keys:
